<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Centro de Gestión de Feedback</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');
    /* ————— Reset & base ————— */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f5f5ff;
      padding: 1rem;
    }
    button { cursor: pointer; }

    /* ————— Layout principal ————— */
    .app-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    /* — Sidebar — */
        aside.sidebar {
      width: 240px;
      background: #fff;
      border-right: 1px solid #eee;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .sidebar .logo-icon {
      display: inline-flex;
      gap: 8px;
      align-items: flex-end;
      margin-bottom: .5rem;
    }
    .sidebar .logo-icon span {
      display: block;
      background: #b30000;
      width: 12px; border-radius: 6px;
    }
    .sidebar .logo-icon span:nth-child(1) { height: 48px; transform: rotate(-10deg); }
    .sidebar .logo-icon span:nth-child(2) { height: 56px; }
    .sidebar .logo-icon span:nth-child(3) { height: 48px; transform: rotate(10deg); }
    .sidebar .logo-text {
      font-size: 1.25rem; font-weight: 600; color: #b30000;
      margin-bottom: 2rem;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: .75rem 1rem;
      color: #333;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: .5rem;
      transition: background .2s;
    }
    .sidebar nav a svg { fill: #b30000; width:20px; height:20px; }
    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: #b30000;
      color: #fff;
    }
    .sidebar nav a.active svg,
    .sidebar nav a:hover svg {
      fill: #fff;
    }

    /* — Main content — */
    main {
      flex: 1;
      padding: 2rem;
    }
    header.main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    header.main-header h1 {
      font-size: 1.8rem;
      color: #b30000;
      font-weight: 600;
    }
    .user-greet {
      font-size: .95rem;
      color: #333;
    }

    /* — Filtros y búsqueda — */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: .9rem;
      font-weight: 600;
      color: #b30000;
      margin-bottom: .25rem;
    }
    .filter-group select {
      padding: .5rem;
      border: 2px solid #b30000;
      border-radius: 8px;
      outline: none;
    }
    .search-group {
      margin-left: auto;
      display: flex;
      align-items: flex-end;
    }
    .search-input {
      padding: .5rem;
      border: 2px solid #b30000;
      border-radius: 8px 0 0 8px;
      outline: none;
    }
    .search-button {
      background: #b30000;
      color: #fff;
      border: none;
      padding: .6rem 1.2rem;
      border-radius: 0 8px 8px 0;
      font-weight: 600;
      transition: background .3s;
    }

    /* — Tabla de feedback — */
    .feedback-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 5px 15px rgba(179,0,0,.1);
      border-radius: 12px;
      overflow: hidden;
      margin-top: 1rem;
    }
    .feedback-table th {
      background: #b30000;
      color: #fff;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
    }
    .feedback-table td {
      padding: .8rem 1rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    .feedback-table tr:nth-child(even) { background: #fff5f5; }
    .feedback-table tr:hover      { background: #ffe6e6; }

    /* — Modal (oculto por defecto) — */
    .modal {
      display: none;
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      padding: 1.5rem;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-close {
      position: absolute;
      top: 1rem; right: 1rem;
      font-size: 1.5rem;
      color: #999;
      cursor: pointer;
    }
    .modal-close:hover { color: #333; }

    .modal-content h2 {
      margin-bottom: 1rem;
      color: #b30000;
    }
    .modal-body > div {
      margin-bottom: .75rem;
    }
    .modal-footer {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
    .modal-footer label {
      font-weight: 600;
    }
    .modal-footer textarea {
      width: 100%;
      padding: .75rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      resize: vertical;
      font-family: 'Montserrat', sans-serif;
    }
    .modal-footer button {
      align-self: flex-end;
    }

    /* — Responsive menor — */
    @media (max-width: 768px) {
      .filters { flex-direction: column; }
      .feedback-table { display: block; overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    {% csrf_token %}
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="logo-icon">
        <span></span><span></span><span></span>
      </div>
      <div class="logo-text">Pomi</div>

      <nav>
        <a href="#dashboard">
          <!-- icono de dashboard (ejemplo) -->
          <svg viewBox="0 0 24 24"><path d="M4 13h6v-6H4v6zm0 8h6v-6H4v6zm8 0h6v-6h-6v6zm0-8h6v-6h-6v6z"/></svg>
          Dashboard
        </a>
        <a href="http://localhost:8000/panel/tickets/" class="active">
          <svg viewBox="0 0 24 24"><path d="M5 8h14v2H5zM5 12h14v2H5z"/></svg>
          Tickets
        </a>
        <a href="#users">
          <svg viewBox="0 0 24 24"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>
          Users
        </a>
        <a href="http://localhost:8000/panel/feedback/">
          <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 0 0-9 9c0 4.97 3.92 9 8.99 9L12 21v-2.07C7.06 18.98 3 14.97 3 10a9 9 0 0 1 18 0 9 9 0 0 1-9 9v2l-.01-.01A9 9 0 0 0 21 12a9 9 0 0 0-9-9z"/></svg>
          FeedBack GPT
        </a>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main>
      <header class="main-header">
        <h1>Actualización de Feedback</h1>
        <div class="user-greet">Bienvenido, Admin</div>
      </header>

      <!-- TABLA -->

      <table class="feedback-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Consulta del Usuario</th>
            <th>Respuesta del Bot</th>
            <th>Fecha de Creación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="feedback-body">
          <!-- Aquí se inyectarán las filas mediante JS -->
          <tr>
            <td>#1</td>
            <td>¿Cuándo es la fecha de entrega del proyecto?</td>
            <td>La fecha de entrega es el 30 de junio.</td>
            <td>2025-06-18 14:00:00</td>
            <td>
              <!-- Icono Editar -->
              <a href="/feedback/edit/1" class="action-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                  <path d="M14.059 2.933l7.999 7.999-2.999 3L11.059 5.933l2.999-3c.49-.49 1.283-.492 1.773 0zM2 16.059V22h5.941l11.618-11.618-5.941-5.941L2 16.059z"/>
                </svg>
                Editar
              </a>
            
              <!-- Icono Eliminar -->
              <a href="/feedback/delete/1" class="action-button" style="color: red;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                  <path d="M6 2L5 3H4v1h1v14h14V4h1V3h-1L18 2h-5V1H11v1H6zM6 18V5h12v13H6z"/>
                </svg>
                Eliminar
              </a>
            </td>
          </tr>
        <!-- Más filas de datos se agregarán aquí -->
      </tbody>
      </table>

    </main>
  </div>

  <!-- MODAL -->
  <div id="feedback-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2>Feedback #<span id="modal-id"></span></h2>
      <div class="modal-body">
        <div><strong>Asunto:</strong> <span id="modal-subject"></span></div>
        <div><strong>Descripción:</strong>
          <p id="modal-desc"></p>
        </div>
        <div><strong>Estudiante:</strong> <span id="modal-student"></span></div>
        <div><strong>Tipo:</strong> <span id="modal-type"></span></div>
        <div><strong>Estado:</strong> <span id="modal-state"></span></div>
      </div>
      <div class="modal-footer">
        <label for="modal-reply">Respuesta al estudiante:</label>
        <textarea id="modal-reply" rows="4" placeholder="Escribe tu respuesta…"></textarea>
        <button id="modal-send" class="action-button">Enviar respuesta</button>
      </div>
    </div>
  </div>

  <script>
    // — Helpers y funciones principales —
    function formatDate(iso) {
      return new Date(iso).toLocaleString('es-PE', {
        day:'2-digit',month:'2-digit',year:'numeric',
        hour:'2-digit',minute:'2-digit'
      });
    }
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    let feedbackData = [];
    let currentFeedbackId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadFeedback();
      document.getElementById('search-button').addEventListener('click', applyFilters);
    });

    async function loadFeedback() {
      const res = await fetch('/api/feedback/');
      feedbackData = await res.json();
      renderTable(feedbackData);
    }

    function applyFilters() {
      const estado = document.getElementById('filter-state').value;
      const texto = document.getElementById('search-input').value.toLowerCase();
      const fil = feedbackData.filter(f => {
        const matchEstado = !estado || f.state === estado;
        const matchTexto = !texto || f.subject.toLowerCase().includes(texto);
        return matchEstado && matchTexto;
      });
      renderTable(fil);
    }

    function renderTable(list) {
      const body = document.getElementById('feedback-body');
      body.innerHTML = '';
      list.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>#${f.id}</td>
          <td>${f.subject}</td>
          <td>${f.student.full_name}</td>
          <td><span class="badge badge-${f.type.toLowerCase()}">${f.type}</span></td>
          <td><span class="badge badge-${f.state}">${f.state}</span></td>
          <td><button class="action-button" onclick="openModal(${f.id})">Ver</button></td>
        `;
        body.appendChild(tr);
      });
    }

    // Modal
    const modal = document.getElementById('feedback-modal');
    const closeIcon = modal.querySelector('.modal-close');
    const fld = {
      id: document.getElementById('modal-id'),
      subject: document.getElementById('modal-subject'),
      desc: document.getElementById('modal-desc'),
      student: document.getElementById('modal-student'),
      type: document.getElementById('modal-type'),
      state: document.getElementById('modal-state'),
      reply: document.getElementById('modal-reply')
    };

    async function openModal(id) {
      currentFeedbackId = id;
      const res = await fetch(`/api/feedback/${id}/`);
      const f = await res.json();
      fld.id.textContent = f.id;
      fld.subject.textContent = f.subject;
      fld.desc.textContent = f.description;
      fld.student.textContent = f.student.full_name;
      fld.type.textContent = f.type;
      fld.state.textContent = f.state;
      fld.reply.value = '';
      modal.classList.add('show');
    }

    closeIcon.onclick = () => modal.classList.remove('show');
    modal.onclick = e => {
      if (e.target === modal) modal.classList.remove('show');
    };

    // Enviar respuesta
    document.getElementById('modal-send').onclick = async () => {
      const msg = fld.reply.value.trim();
      if (!msg) return alert('Escribe una respuesta antes de enviar.');
      const res = await fetch(`/api/feedback/${currentFeedbackId}/reply/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ message: msg })
      });
      if (res.ok) {
        alert('Respuesta enviada con éxito.');
        modal.classList.remove('show');
      } else {
        alert('Error enviando la respuesta.');
      }
    };
  </script>
</body>
</html>
